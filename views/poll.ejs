<%- include('partials/header') %>
<main class="container">
    <h1><%= poll.title %></h1>
    <p>Sentiment: <%= poll.sentiment.score > 0 ? 'Positive' : 'Negative' %></p>
    <p>Ends: <%= poll.endTime.toLocaleString() %></p>
    <p>Time Left: <span id="timer"></span></p>
    <p>Voting: <%= poll.isAnonymous ? 'Anonymous' : 'Public' %></p>
    
    <div class="poll-options">
        <% poll.options.forEach((opt, i) => { %>
            <div>
                <button class="vote-btn" data-index="<%= i %>"><%= opt.text %></button>
                <% if (isCreator) { %>
                    (<span class="votes"><%= opt.votes %></span>)
                <% } %>
            </div>
        <% }) %>
    </div>
    
    <div class="poll-share">
        <img src="<%= qrCode %>" alt="QR Code">
        <p>Share URL: <input type="text" value="<%= shareUrl %>" readonly></p>
    </div>
    
    <% if (isCreator) { %>
        <div class="export-buttons">
            <a href="/poll/<%= poll._id %>/export/csv" class="btn">Export CSV</a>
            <a href="/poll/<%= poll._id %>/export/pdf" class="btn">Export PDF</a>
        </div>
    <% } %>
</main>
<%- include('partials/footer') %>

<script>
  // Countdown timer
  let timeLeft = <%= timeLeft %>; // Already in seconds from server
  
  const timerElement = document.getElementById('timer');
  
  function updateTimer() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    timerElement.textContent = `${minutes}m ${seconds}s`;
    if (timeLeft <= 0) {
      timerElement.textContent = 'Poll Ended';
      document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = true);
    } else {
      timeLeft--;
      setTimeout(updateTimer, 1000);
    }
  }
  if (timeLeft >= 0) {
    updateTimer();
  } else {
    timerElement.textContent = 'Poll Ended';
    document.querySelectorAll('.vote-btn').forEach(btn => btn.disabled = true);
  }

  // Voting functionality
  document.querySelectorAll('.vote-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const index = btn.dataset.index;
      const pollId = window.location.pathname.split('/')[2];
      
      const response = await fetch(`/poll/${pollId}/vote`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ optionIndex: index })
      });
      
      if (response.ok) {
        const data = await response.json();
        if (document.querySelector('.votes')) { // Only update if creator
          document.querySelectorAll('.votes').forEach((span, i) => {
            span.textContent = data.options[i].votes;
          });
        }
        btn.disabled = true; // Disable button after voting
      } else {
        const error = await response.json();
        alert(error.error);
      }
    });
  });
</script>
